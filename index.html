<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Paint Palette Picker</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { background:#0f172a; color:white; }
.marker {
  width:20px;
  height:20px;
  border:3px solid white;
  border-radius:50%;
  position:absolute;
  cursor:pointer;
}
</style>
</head>
<body class="p-6">

<h1 class="text-3xl font-bold mb-6">Paint Palette Picker</h1>

<input type="file" id="imageInput" accept="image/*" class="mb-4">

<div class="flex gap-6 flex-wrap">
  <div class="relative">
    <img id="imagePreview" class="max-w-md border border-white/20 rounded">
    <div id="markerLayer" class="absolute inset-0"></div>
  </div>

  <div class="w-96">
    <h2 class="text-xl mb-2">Extracted Colors</h2>
    <div id="palette"></div>

    <h2 class="text-xl mt-6 mb-2">Matches</h2>
    <div id="matches"></div>
  </div>
</div>

<script>
// ===============================
// Paint Database
// ===============================

const paints = [
  {id:"citadel_abaddon", brand:"Citadel", name:"Abaddon Black", hex:"#231F20"},
  {id:"citadel_mephiston", brand:"Citadel", name:"Mephiston Red", hex:"#9A1115"},
  {id:"citadel_naggaroth", brand:"Citadel", name:"Naggaroth Night", hex:"#3D3354"},

  {id:"ap_warlock", brand:"Army Painter", name:"Warlock Purple", hex:"#5A2A56"},
  {id:"ap_uniform", brand:"Army Painter", name:"Uniform Grey", hex:"#5E6366"},

  {id:"pro_boldred", brand:"Pro Acryl", name:"Bold Pyrrole Red", hex:"#C11B1B"},
  {id:"pro_blue", brand:"Pro Acryl", name:"Blue", hex:"#2F5DA8"},

  {id:"vallejo_black", brand:"Vallejo", name:"Black", hex:"#1C1C1C"},
  {id:"vallejo_white", brand:"Vallejo", name:"White", hex:"#F5F5F5"}
];

// ===============================
// Owned Paint System
// ===============================

let owned = new Set(JSON.parse(localStorage.getItem("owned") || "[]"));

function toggleOwned(id) {
  if (owned.has(id)) owned.delete(id);
  else owned.add(id);
  localStorage.setItem("owned", JSON.stringify([...owned]));
}

// ===============================
// Image + Palette
// ===============================

const imageInput = document.getElementById("imageInput");
const imagePreview = document.getElementById("imagePreview");
const markerLayer = document.getElementById("markerLayer");
const paletteDiv = document.getElementById("palette");
const matchesDiv = document.getElementById("matches");

let palette = [];

imageInput.addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    imagePreview.src = reader.result;
  };
  reader.readAsDataURL(file);
});

imagePreview.onload = () => {
  extractColors();
};

function extractColors() {
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  canvas.width = imagePreview.naturalWidth;
  canvas.height = imagePreview.naturalHeight;
  ctx.drawImage(imagePreview, 0, 0);

  const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
  const data = imageData.data;

  palette = [];

  for (let i=0; i<data.length; i+=10000) {
    const r = data[i];
    const g = data[i+1];
    const b = data[i+2];
    palette.push(rgbToHex(r,g,b));
    if (palette.length >= 5) break;
  }

  renderPalette();
  renderMarkers();
  renderMatches();
}

function rgbToHex(r,g,b){
  return "#" + [r,g,b].map(x=>x.toString(16).padStart(2,"0")).join("").toUpperCase();
}

// ===============================
// Markers
// ===============================

function renderMarkers(){
  markerLayer.innerHTML = "";
  palette.forEach((color,i)=>{
    const marker = document.createElement("div");
    marker.className="marker";
    marker.style.background=color;
    marker.style.left=(Math.random()*300)+"px";
    marker.style.top=(Math.random()*300)+"px";
    markerLayer.appendChild(marker);
  });
}

// ===============================
// Matching
// ===============================

function renderPalette(){
  paletteDiv.innerHTML="";
  palette.forEach(c=>{
    paletteDiv.innerHTML+=`
      <div class="flex items-center gap-2 mb-2">
        <div class="w-6 h-6 rounded" style="background:${c}"></div>
        <span>${c}</span>
      </div>
    `;
  });
}

function renderMatches(){
  matchesDiv.innerHTML="";
  const used = new Set();

  palette.forEach(color=>{
    const best = paints
      .map(p=>({...p, score:colorDistance(color,p.hex)}))
      .sort((a,b)=>a.score-b.score)
      .filter(p=>!used.has(p.id))
      .slice(0,3);

    best.forEach(p=>{
      used.add(p.id);
      matchesDiv.innerHTML+=`
        <div class="border border-white/20 p-2 mb-2 rounded">
          <div class="flex justify-between">
            <span>${p.name}</span>
            <input type="checkbox"
              ${owned.has(p.id)?"checked":""}
              onchange="toggleOwned('${p.id}')">
          </div>
          <div class="text-sm text-gray-400">${p.brand}</div>
        </div>
      `;
    });
  });
}

function colorDistance(a,b){
  const ar = parseInt(a.slice(1,3),16);
  const ag = parseInt(a.slice(3,5),16);
  const ab = parseInt(a.slice(5,7),16);

  const br = parseInt(b.slice(1,3),16);
  const bg = parseInt(b.slice(3,5),16);
  const bb = parseInt(b.slice(5,7),16);

  return Math.sqrt((ar-br)**2+(ag-bg)**2+(ab-bb)**2);
}

</script>
</body>
</html>
